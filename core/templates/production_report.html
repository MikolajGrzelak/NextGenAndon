{% extends "base.html" %}
{% load static %}
{% block content %}

<style>
  body {
    background: #f8f9fa;
  }

  .report-header {
    background: linear-gradient(to right, #0d6efd, #6610f2);
    color: #fff;
    padding: 2rem 1rem;
    text-align: center;
    margin-bottom: 2rem;
    border-radius: 0.5rem;
  }

  .chart-container {
    background: #fff;
    border-radius: 0.75rem;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
    padding: 1rem;
    height: 500px;
    max-height: 500px;
    width: 100%;
    max-width: 900px;
    margin: auto;
    justify-content: center;
  }
  canvas {
    max-height: 100%;
  }

  .filter-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    margin-bottom: 1rem;
  }

  .filter-buttons button {
    border: 1px solid #ddd;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
  }

  .filter-active {
    background-color: #007bff !important;
    color: white !important;
  }

  .status-badge {
    display: inline-block;
    padding: 0.25rem 0.6rem;
    border-radius: 0.5rem;
    font-size: 0.85rem;
    font-weight: 500;
    text-transform: capitalize;
  }

  /* Kolory dla poszczególnych statusów */
  .status-new { background-color: #e2e3ff; color: #555; }        /* Fioletowy jasny */
  .status-in_progress { background-color: #ffe3ba; color: #555; } /* Pomarańczowy */
  .status-wip { background-color: #cff4fc; color: #555; }         /* Jasny niebieski */
  .status-printed { background-color: #fff3cd; color: #555; }     /* Żółty */
  .status-completed { background-color: #d1e7dd; color: #0f5132; } /* Zielony */
  .status-stopped { background-color: #f8d7da; color: #842029; }  /* Czerwony */

  /* KAFELKI STATYSTYK */
  .stats-cards .card {
    border: none;
    border-radius: 0.75rem;
    box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
    background: #ffffff;
    transition: transform 0.2s ease-in-out;
  }

  .stats-cards .card:hover {
    transform: scale(1.03);
  }

  .stats-cards .card-body {
    text-align: center;
    padding: 1.5rem;
  }

  .stats-cards .progress {
    height: 5px;
    border-radius: 10px;
    overflow: hidden;
    background: rgba(0, 0, 0, 0.1);
  }

  .stats-cards .progress-bar {
    border-radius: 10px;
  }

  .bg-primary {
    background-color: #005eff !important;
  }
  .bg-success {
    background-color: #1e7e34 !important;
  }
  .bg-info {
    background-color: #17a2b8 !important;
  }
  .bg-warning {
    background-color: #ffc107 !important;
  }

  .stats-cards .card-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 0.5rem;
  }

  .stats-cards .display-6 {
    font-size: 2rem;
    font-weight: 700;
    color: #222;
  }
</style>

<div class="report-header">
  <h1>Raport Wykonania Produkcji</h1>
  <p>Podsumowanie stanu zleceń produkcyjnych i aktualnego wykonania</p>
</div>

<div class="container">

  <!-- FILTRY -->
  <div class="d-flex justify-content-between flex-wrap mb-3">
    <div class="d-flex flex-wrap gap-2">
      <button class="btn btn-outline-secondary filter-btn" data-type="line" data-value="SC1">ScanCoin</button>
      {% for line in lines %}
        <button class="btn btn-outline-secondary filter-btn" data-type="line" data-value="{{ line }}">{{ line }}</button>
      {% endfor %}
    
    <button class="btn btn-outline-secondary filter-btn" data-type="line" data-value="C2">C2</button>
      {% for line in lines %}
        <button class="btn btn-outline-secondary filter-btn" data-type="line" data-value="{{ g }}">{{ g }}</button>
      {% endfor %}

      <button class="btn btn-outline-secondary filter-btn" data-type="line" data-value="RM5">RM5</button>
      {% for line in lines %}
        <button class="btn btn-outline-secondary filter-btn" data-type="line" data-value="{{ line }}">{{ line }}</button>
      {% endfor %}
  
      <button class="btn btn-outline-secondary filter-btn" data-type="line" data-value="B2B">B2B</button>
      {% for line in lines %}
        <button class="btn btn-outline-secondary filter-btn" data-type="line" data-value="{{ g }}">{{ g }}</button>
      {% endfor %}

      <button class="btn btn-outline-secondary filter-btn" data-type="line" data-value="COM">Come</button>
      {% for line in lines %}
        <button class="btn btn-outline-secondary filter-btn" data-type="line" data-value="{{ line }}">{{ line }}</button>
      {% endfor %}
  
      <button class="btn btn-outline-secondary filter-btn" data-type="line" data-value="DC1">Gaming</button>
      {% for line in lines %}
        <button class="btn btn-outline-secondary filter-btn" data-type="line" data-value="{{ g }}">{{ g }}</button>
      {% endfor %}
    </div>

    <div class="d-flex flex-wrap gap-2">
      <button class="btn btn-outline-secondary filter-btn" data-type="date" data-value="overdue">Zaległe</button>
      <button class="btn btn-outline-secondary filter-btn" data-type="date" data-value="this_week">Ten tydzień</button>
      <button class="btn btn-outline-secondary filter-btn" data-type="date" data-value="today">Dzisiejsze</button>
    </div>
  </div>

  <!-- KAFELKI STATYSTYK -->
  <div class="row row-cols-1 row-cols-md-4 g-4 stats-cards mb-3">
    <div class="col">
      <div class="card">
        <div class="card-body">
          <div class="progress mb-2">
            <div class="progress-bar bg-primary" style="width: 100%;"></div>
          </div>
          <h5 class="card-title">Otwarte zlecenia</h5>
          <p class="display-6" id="openOrders">{{ open_orders|default:"0" }}</p>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <div class="card-body">
          <div class="progress mb-2">
            <div class="progress-bar bg-success" style="width: 100%;"></div>
          </div>
          <h5 class="card-title">Ilość planowana</h5>
          <p class="display-6" id="totalPlanned">{{ total_planned|default:"0" }}</p>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <div class="card-body">
          <div class="progress mb-2">
            <div class="progress-bar bg-info" style="width: 100%;"></div>
          </div>
          <h5 class="card-title">Ilość wykonana</h5>
          <p class="display-6" id="totalDone">{{ total_done|default:"0" }}</p>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <div class="card-body">
          <div class="progress mb-2">
            <div class="progress-bar bg-warning" style="width: 100%;"></div>
          </div>
          <h5 class="card-title">Wykonanie (%)</h5>
          <p class="display-6" id="globalPercent">{{ global_percent|default:"0" }}%</p>
        </div>
      </div>
    </div>
  </div>

  <!-- WYKRES -->
  <div class="chart-container">
    <h3>Plan vs. Wykonanie (MO Number)</h3>
    <canvas id="planVsDoneChart"></canvas>
  </div>

  <!-- TABELA -->
  <div class="report-table p-3 mt-4">
    <h3 class="mb-3">Szczegóły zleceń</h3>
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>MO Number</th>
            <th>Data</th>
            <th>Item</th>
            <th>Plan</th>
            <th>Wykonanie</th>
            <th>%</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="reportTableBody">
          {% for row in results %}
          <tr>
            <td>{{ row.mo_number }}</td>
            <td>{{ row.date }}</td>
            <td>{{ row.item }}</td>
            <td>{{ row.planned }}</td>
            <td>{{ row.done }}</td>
            <td>{{ row.percent }} %</td>
            <td>
              <span class="status-badge status-{{ row.status }}">
                {{ row.status }}
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  let chartInstance;

  function updateChart(data) {
    if (chartInstance) {
      chartInstance.destroy();
    }
    const ctx = document.getElementById('planVsDoneChart').getContext('2d');
    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: data.labels,
        datasets: [
          {
            label: 'Planowana ilość',
            data: data.planned,
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          },
          {
            label: 'Wykonana ilość',
            data: data.done,
            backgroundColor: 'rgba(255, 99, 132, 0.5)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true
      }
    });
  }

  function fetchReportData(filters = {}) {
    $.ajax({
      url: "{% url 'get_production_report_data' %}",
      data: filters,
      dataType: "json",
      success: function(response) {
        updateChart(response);

        let rows = "";
        response.results.forEach(row => {
          rows += `
            <tr>
              <td>${row.mo_number}</td>
              <td>${row.date}</td>
              <td>${row.item}</td>
              <td>${row.planned}</td>
              <td>${row.done}</td>
              <td>${row.percent} %</td>
              <td><span class="status-badge status-${row.status}">${row.status}</span></td>
            </tr>
          `;
        });

        $("#reportTableBody").html(rows);

        // Aktualizacja statystyk
        $("#openOrders").text(response.stats.open_orders || 0);
        $("#totalPlanned").text(response.stats.total_planned || 0);
        $("#totalDone").text(response.stats.total_done || 0);
        $("#globalPercent").text(response.stats.global_percent || 0 + "%");
      },
      error: function() {
        alert("Błąd pobierania danych raportu");
      }
    });
  }

  $(document).ready(function() {
    let filters = {};

    $(".filter-btn").click(function() {
      let type = $(this).data("type");
      let value = $(this).data("value");

      if (filters[type] === value) {
        delete filters[type];
        $(this).removeClass("filter-active");
      } else {
        filters[type] = value;
        $(".filter-btn[data-type=" + type + "]").removeClass("filter-active");
        $(this).addClass("filter-active");
      }

      fetchReportData(filters);
    });

    fetchReportData();
  });
</script>

{% endblock %}