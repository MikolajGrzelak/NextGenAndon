{% extends "base.html" %}
{% block content %}

<style>
  /* Kolorowanie wierszy przez <td>, by nadpisaƒá table-striped */
  .row-new td { background-color: #ffffff !important; }
  .row-in_progress td { background-color: #ffa500 !important; }
  .row-wip td { background-color: #add8e6 !important; }
  .row-printed td { background-color: #ffffcc !important; }
  .row-completed td { background-color: #90ee90 !important; }
  .row-stopped td { background-color: #ff9999 !important; }

  /* Pod≈õwietlenie aktywnego przycisku filtra */
  .filter-active {
    background-color: #6c757d !important; 
    color: #fff !important;
    border-color: #6c757d !important;
  }
</style>

<div class="container mt-4">
    <h2 class="mb-4">üìã Plan Produkcji</h2>

    <!-- Filtry -->
    <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
        <button class="btn btn-outline-secondary filter-btn" data-filter="line" data-value="">Wszystkie Linie</button>
        {% for line in lines %}
            <button class="btn btn-outline-secondary filter-btn" data-filter="line" data-value="{{ line }}">{{ line }}</button>
        {% endfor %}
    </div>
    <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
        <button class="btn btn-outline-secondary filter-btn" data-filter="gpg" data-value="">Wszystkie GPG</button>
        {% for gpg in gpgs %}
            <button class="btn btn-outline-secondary filter-btn" data-filter="gpg" data-value="{{ gpg }}">{{ gpg }}</button>
        {% endfor %}
    </div>

    <!-- Tabela wynik√≥w -->
    <table class="table table-striped table-hover" id="planTable">
        <thead>
            <tr>
                <th>Linia</th>
                <th>GPG</th>
                <th>MO Number</th>
                <th>Item Code</th>
                <th>Opis</th>
                <th>Planowana</th>
                <th>Wykonana</th>
                <th>Data</th>
                <th>Status</th>
                <th>Akcje</th>
            </tr>
        </thead>
        <tbody>
            <!-- Wype≈Çniane przez AJAX -->
        </tbody>
    </table>
</div>
<!-- Modal do komentarzy -->
<div class="modal fade" id="commentsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Komentarze</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Sekcja istniejƒÖcych komentarzy -->
                <div id="commentsContent">≈Åadujƒô komentarze...</div>

                <hr>

                <!-- Sekcja dodawania nowego komentarza -->
                <h5>Dodaj nowy komentarz</h5>
                <div class="mb-3">
                    <textarea class="form-control" id="newCommentText" rows="2" placeholder="Wpisz komentarz..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="submitNewComment()">Dodaj</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    let currentFilters = {
        line: "",
        gpg: "",
        date: "",
        status: "",
        mo_number: "",
        item_code: ""
    };

    function loadPlanData() {
        $.ajax({
            url: "{% url 'production_plan_data' %}",
            data: currentFilters,
            dataType: "json",
            success: function(response) {
                let rows = "";
                response.results.forEach(function(row) {
                    let rowClass = getRowClass(row.status);
                    rows += `
                        <tr class="${rowClass}">
                          <td>${row.line}</td>
                          <td>${row.gpg}</td>
                          <td>${row.mo_number}</td>
                          <td>${row.item_code}</td>
                          <td>${row.description || ""}</td>
                          <td>${row.planned_quantity}</td>
                          <td>${row.completed_quantity}</td>
                          <td>${row.date}</td>
                          <td>${row.status}</td>
                          <td>
                            <button class="btn btn-primary btn-sm" onclick="openEditModal(${row.id})">‚úèÔ∏è</button>
                            <button class="btn btn-secondary btn-sm" onclick="openComments(${row.id})">üí¨</button>
                          </td>
                        </tr>
                    `;
                });
                $("#planTable tbody").html(rows);
            },
            error: function() {
                alert("B≈ÇƒÖd pobierania danych planu");
            }
        });
    }

    function getRowClass(status) {
        switch (status) {
            case "new": return "row-new";
            case "in_progress": return "row-in_progress";
            case "wip": return "row-wip";
            case "printed": return "row-printed";
            case "completed": return "row-completed";
            case "stopped": return "row-stopped";
            default: return "";
        }
    }

    function openComments(planId) {
        const modal = new bootstrap.Modal(document.getElementById("commentsModal"));
        $("#commentsContent").html("≈Åadujƒô komentarze...");
        $.get(`/get-comments/${planId}/`, function(response) {
            let commentsHtml = "";
            response.comments.forEach(function(comment) {
                commentsHtml += `<div class="mb-2"><strong>${comment.user}:</strong> ${comment.text}</div>`;
            });
            $("#commentsContent").html(commentsHtml || "Brak komentarzy.");
        });
        currentOrderIdForComments = planId;
        modal.show();
    }

    function submitNewComment() {
        const commentText = $("#newCommentText").val().trim();
        if (!commentText) {
            alert("Komentarz nie mo≈ºe byƒá pusty!");
            return;
        }
    
        // Wy≈õlij komentarz do serwera
        $.ajax({
            url: `/add-comment/${currentOrderIdForComments}/`, // currentOrderIdForComments odnosi siƒô do ProductionPlan
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            },
            data: {
                text: commentText
            },
            success: function(response) {
                if (response.success) {
                    // Dodaj nowy komentarz do listy
                    const newCommentHtml = `<div class="mb-2"><strong>${response.user}:</strong> ${response.text}</div>`;
                    $("#commentsContent").append(newCommentHtml);
    
                    // Wyczy≈õƒá pole tekstowe
                    $("#newCommentText").val("");
                } else {
                    alert(response.error || "Nie uda≈Ço siƒô dodaƒá komentarza.");
                }
            },
            error: function() {
                alert("WystƒÖpi≈Ç b≈ÇƒÖd podczas dodawania komentarza.");
            }
        });
    }

    $(document).ready(function() {
        // Za≈Çaduj dane przy pierwszym uruchomieniu
        loadPlanData();

        // Obs≈Çuga filtr√≥w
        $(".filter-btn").click(function() {
            const filterType = $(this).data("filter");
            const filterValue = $(this).data("value");

            // Zaktualizuj aktywny filtr
            currentFilters[filterType] = filterValue;

            // Pod≈õwietl aktywny przycisk
            $(`.filter-btn[data-filter="${filterType}"]`).removeClass("filter-active");
            $(this).addClass("filter-active");

            // Za≈Çaduj dane z nowymi filtrami
            loadPlanData();
        });
    });
</script>

{% endblock %}